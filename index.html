<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>강화 시뮬레이션</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
      max-width: 700px;
      line-height: 1.4;
    }
    label {
      display: inline-block;
      width: 50px;
      font-weight: bold;
    }
    .prob-input, .target-input {
      margin-bottom: 10px;
    }
    #resultArea {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #fafafa;
      white-space: pre-wrap;
    }
    button {
      margin-top: 10px;
      margin-right: 10px;
      padding: 6px 12px;
    }
  </style>
</head>
<body>

<div class="target-input">
  <label>목표:</label>
  <input type="number" id="targetStage" value="5" min="1" max="9" />
  <span>(1 ~ 9 범위)</span>
</div>

<!-- 단계별 성공 확률 (%) 입력 -->
<div class="prob-input">
  <div><label>0강:</label><input type="number" id="p0" value="12" step="0.01" /> %</div>
  <div><label>1강:</label><input type="number" id="p1" value="10" step="0.01" /> %</div>
  <div><label>2강:</label><input type="number" id="p2" value="7"  step="0.01" /> %</div>
  <div><label>3강:</label><input type="number" id="p3" value="5"  step="0.01" /> %</div>
  <div><label>4강:</label><input type="number" id="p4" value="4"  step="0.01" /> %</div>
  <div><label>5강:</label><input type="number" id="p5" value="3"  step="0.01" /> %</div>
  <div><label>6강:</label><input type="number" id="p6" value="2"  step="0.01" /> %</div>
  <div><label>7강:</label><input type="number" id="p7" value="2"  step="0.01" /> %</div>
  <div><label>8강:</label><input type="number" id="p8" value="1"  step="0.01" /> %</div>
</div>

<button id="startBtn">시뮬레이션 시작</button>

<div id="resultArea"></div>

<script>
/*
  ----------------------------------------------------------
   1) 기대값 계산 함수: computeExpected(probList, targetStage)
     - 0강부터 targetStage-1강까지 각 상태의 기댓값 E(k)를 반복적으로 계산
     - E(targetStage)=0 으로 두고, k < targetStage인 k에 대해서만 식을 세움
     - (실패 시 3강 이하로는 안 내려가지만, 0~3강이면 하락 없음)
  ----------------------------------------------------------
*/
function computeExpected(probList, targetStage) {
  // E(i) : i강에서 목표강 도달까지 필요한 '평균 시도 횟수'
  // 최대 0~9 단계를 다룬다고 가정. (문제에서 9강이 최대)
  const E = new Array(10).fill(0);

  // 상태 i >= targetStage → 이미 도달 상태로 간주, E(i)=0
  // (배열 초기값이 0이므로 별도 설정 불필요)

  // 반복(Iterative) 방법으로 수렴
  const maxIter = 10000;
  const eps = 1e-12;

  for (let iter = 0; iter < maxIter; iter++) {
    let diffMax = 0;
    const oldE = [...E]; // 이전 값을 복사해둠

    // k = targetStage-1부터 0까지, 역순으로 업데이트
    for (let k = targetStage - 1; k >= 0; k--) {
      const p = probList[k];
      if (p <= 0) {
        // 만약 성공 확률 0%라면, 이론적으로 무한대가 됩니다.
        // 편의상 아주 큰 수로 처리하거나, 별도 에러 처리 가능.
        E[k] = Infinity;
        continue;
      }

      if (k < 4) {
        // 0~3강: 실패시 하락 없음 → 식: E(k) = 1 + p_k * E(k+1) + (1-p_k)*E(k)
        // 정리하면: E(k) - (1-p_k)*E(k) = 1 + p_k*E(k+1)
        //           p_k * E(k) = 1 + p_k * E(k+1)
        //           E(k) = 1/p_k + E(k+1)
        const nextE = (k + 1 < targetStage) ? E[k + 1] : 0;
        E[k] = (1 + p * nextE) / p;
      } else {
        // 4강 이상: 실패 시 1단계 하락 (단, 3강 이하로 내려가지 않음)
        // → failStage = max(3, k-1)
        const nextStage = (k + 1 < targetStage) ? E[k + 1] : 0;
        const failStageIndex = Math.max(3, k - 1); // 실패 후 단계
        const failVal = (failStageIndex < targetStage) ? E[failStageIndex] : 0;

        // E(k) = 1 + p_k * E(k+1) + (1-p_k)*E(failStage)
        E[k] = 1 + p * nextStage + (1 - p) * failVal;
      }
    }

    // 수렴 판정
    for (let i = 0; i < 10; i++) {
      diffMax = Math.max(diffMax, Math.abs(E[i] - oldE[i]));
    }
    if (diffMax < eps) {
      break; // 충분히 변동이 작아졌으면 종료
    }
  }

  // 결과: E[0] = '0강에서 시작했을 때' 목표 도달까지 평균 시도 횟수
  return E[0];
}

/*
  ----------------------------------------------------------
   2) 단일 시뮬레이션: runSingleSimulation(probList, targetStage)
     - 실제로 0강에서 시작하여, 목표강에 도달할 때까지
       강화 시도를 랜덤으로 반복
  ----------------------------------------------------------
*/
function runSingleSimulation(probList, targetStage) {
  let stage = 0;
  let attempts = 0;

  while (stage < targetStage) {
    attempts++;
    const r = Math.random();
    const p = probList[stage];

    if (r < p) {
      // 성공: +1단계
      stage++;
    } else {
      // 실패
      if (stage >= 4) {
        // 4강 이상이면 1단계 하락 (단, 3강 이하로는 안내려감)
        stage = Math.max(3, stage - 1);
      }
      // 0~3강이면 하락 없음 (stage 그대로)
    }
  }

  return attempts;
}

/*
  ----------------------------------------------------------
   3) 여러 번(예: 10회) 시뮬레이션
  ----------------------------------------------------------
*/
function runMultipleSimulations(probList, targetStage, count) {
  const results = [];
  for (let i = 0; i < count; i++) {
    const res = runSingleSimulation(probList, targetStage);
    results.push(res);
  }
  return results;
}

/*
  ----------------------------------------------------------
   4) 메인: UI 이벤트 처리
  ----------------------------------------------------------
*/
document.getElementById('startBtn').addEventListener('click', () => {
  const targetStage = parseInt(document.getElementById('targetStage').value, 10);

  if (isNaN(targetStage) || targetStage < 1 || targetStage > 9) {
    alert('목표 단계는 1~9 사이의 정수로 입력해주세요!');
    return;
  }

  // 단계별 확률 입력값 읽어오기 (0~8)
  const p0 = parseFloat(document.getElementById('p0').value) / 100;
  const p1 = parseFloat(document.getElementById('p1').value) / 100;
  const p2 = parseFloat(document.getElementById('p2').value) / 100;
  const p3 = parseFloat(document.getElementById('p3').value) / 100;
  const p4 = parseFloat(document.getElementById('p4').value) / 100;
  const p5 = parseFloat(document.getElementById('p5').value) / 100;
  const p6 = parseFloat(document.getElementById('p6').value) / 100;
  const p7 = parseFloat(document.getElementById('p7').value) / 100;
  const p8 = parseFloat(document.getElementById('p8').value) / 100;
  const probList = [p0, p1, p2, p3, p4, p5, p6, p7, p8];

  // 1) 기대 시도 횟수 계산
  const expected = computeExpected(probList, targetStage);

  // 2) 10번 시뮬레이션 실행
  const simCount = 10;
  const results = runMultipleSimulations(probList, targetStage, simCount);

  // 결과 표시
  const resultArea = document.getElementById('resultArea');
  let output = `◆ 목표: ${targetStage}강\n`;
  output += `◆ 단계별 성공 확률: [0강→${(p0*100).toFixed(2)}%, 1강→${(p1*100).toFixed(2)}%, ... 8강→${(p8*100).toFixed(2)}%]\n\n`;

  if (expected === Infinity) {
    output += `● 기대 시도 횟수: ∞ \n\n`;
  } else {
    output += `● 기대 시도 횟수: 약 ${expected.toFixed(2)} 회\n\n`;
  }

  output += `=== 시뮬레이션 ${simCount}회 결과 ===\n`;
  let sum = 0;
  results.forEach((val, idx) => {
    sum += val;
    output += ` #${idx+1} → ${val} 회\n`;
  });
  const avg = sum / simCount;
  output += `\n→ 10회 평균: ${avg.toFixed(2)} 회\n`;

  resultArea.textContent = output;
});
</script>

</body>
</html>
